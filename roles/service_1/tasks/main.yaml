# Create or update a Service 1, Imperative Build Simple Application

      - name: Wait a maximum of 300 seconds for BIG-IP to be ready to take configuration
        bigip_wait:
          timeout: 300
          password: "{{BIGIPadminPassword}}"
          server: "{{resource_group_name}}.{{location}}.cloudapp.azure.com"
          user: "{{BIGIPadminUsername}}"
          validate_certs: no
        delegate_to: localhost

      - name: Create pool test
        bigip_pool:
          server: "{{resource_group_name}}.{{location}}.cloudapp.azure.com"
          user: "{{ BIGIPadminUsername }}"
          password: "{{ BIGIPadminPassword }}"
          state: present
          name: my-pool
          partition: Common
          lb_method: least-connections-member
          slow_ramp_time: 120
        delegate_to: localhost

      - name: Create a pool
        bigip_pool:
            lb_method: "ratio-member"
            name: "service_1_pl"
            password: "{{ BIGIPadminPassword }}"
            server: "{{resource_group_name}}.{{location}}.cloudapp.azure.com"
            slow_ramp_time: "120"
            user: "{{ BIGIPadminUsername }}"
            validate_certs: no
        delegate_to: localhost

      - name: Create node1
        bigip_node:
            host: "10.10.10.10"
            name: "node-1"
            password: "{{ BIGIPadminPassword }}"
            server: "{{resource_group_name}}.{{location}}.cloudapp.azure.com"
            user: "{{ BIGIPadminUsername }}"
            validate_certs: no
        delegate_to: localhost

      - name: Add nodes to pool
        bigip_pool_member:
            description: "webserver-1"
            host: "{{ item.host }}"
            name: "{{ item.name }}"
            password: "{{ BIGIPadminPassword }}"
            pool: "service_1_pl"
            port: "80"
            server: "{{resource_group_name}}.{{location}}.cloudapp.azure.com"
            user: "{{ BIGIPadminUsername }}"
            validate_certs: no
        delegate_to: localhost
        with_items:
            - host: "10.128.20.4"
              name: "node-1"

      - name: Edit Security Group {{resource_group_name}}-ext-nsg in {{resource_group_name}}
        azure_rm_securitygroup:
          tenant: "{{ tenantId }}"
          client_id: "{{ clientId }}"
          secret: "{{ servicePrincipalSecret }}"
          subscription_id: "{{ subscriptionId }}"
          resource_group: "{{resource_group_name}}"
          name: "{{resource_group_name}}-ext-nsg"
          purge_rules: no
          rules:
            - name: 'AllowHTTP'
              protocol: Tcp
              source_address_prefix: '{{restrictedSrcAddress}}'
              destination_port_range: 80
              access: Allow
              priority: 100
              direction: Inbound

      - name: Create a VIP
        bigip_virtual_server:
            description: "foo-vip"
            destination: "10.128.10.21"
            password: "{{ BIGIPadminPassword }}"
            name: "service_1_vs"
            pool: "service_1_pl"
            port: "80"
            server: "{{resource_group_name}}.{{location}}.cloudapp.azure.com"
            snat: "Automap"
            user: "{{ BIGIPadminUsername }}"
            all_profiles:
                - "http"
                - "clientssl"
            validate_certs: no
        delegate_to: localhost

      - name: Webhook Notification to Teams for Build
        delegate_to: localhost
        uri:
          body: "{\"text\": \"Service 1 was created from individual modules!\"}"
          body_format: json
          method: POST
          status_code: 200
          url: "{{teams_webhook}}"
          validate_certs: no
