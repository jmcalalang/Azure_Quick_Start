---

- name: Wait for {{bigIqCM}} to be available
  uri:
    url: "https://{{ bigIqCM_mgmt_pip }}/info/system"
    method: GET
    return_content: yes
    status_code: 200
    body_format: json
  register: response
  until: " {{ response.state.available }} " == "true"
  retries: 10
  delay: 6

#- name: Wait for {{bigIqCM}} to be available
#  uri:
#    url: "https://{{ bigIqCM_mgmt_pip }}/info/system"
#    validate_certs: no
#  register: status
#  until: status is success and status.json.available|True
#  retries: 10
#  delay: 6

- name: Test Authentication
  uri:
    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/shared/echo"
    validate_certs: no
    user: "{{ bigIqCMAdmin }}"
    password: "{{ bigIqCMPassword }}"

- name: License {{bigIqCM}}
  uri:
    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/tm/sys/license"
    method: POST
    validate_certs: no
    user: "{{ bigIqCMAdmin }}"
    password: "{{ bigIqCMPassword }}"
    body:
      command: "install"
      registrationKey: "{{ bigIqCMLicense }}"
    body_format: json

- name: Set {{bigIqCM}} Personality
  uri:
    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/cm/system/provisioning"
    method: POST
    validate_certs: no
    user: "{{ bigIqCMAdmin }}"
    password: "{{ bigIqCMPassword }}"
    body:
      systemPersonality: "big_iq"
    body_format: json

- name: Execute easy-setup on {{bigIqCM}}
  uri:
    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/shared/system/easy-setup"
    method: PATCH
    validate_certs: no
    user: "{{ bigIqCMAdmin }}"
    password: "{{ bigIqCMPassword }}"
    body:
      hostname: "{{bigIqCM}}.iq"
    body_format: json

- name: Set Master Key on {{bigIqCM}}
  uri:
    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/cm/shared/secure-storage/masterkey"
    method: POST
    validate_certs: no
    user: "{{ bigIqCMAdmin }}"
    password: "{{ bigIqCMPassword }}"
    body:
      passphrase: "{{bigIqHostPassphrase}}"
    body_format: json

- name: Set Admin Credentials {{bigIqCM}}
  uri:
    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/shared/authz/users"
    method: PUT
    validate_certs: no
    user: "{{ bigIqCMAdmin }}"
    password: "{{ bigIqCMPassword }}"
    body:
      name: "{{ bigIqCMAdmin }}"
      oldPassword: "{{ bigIqCMPassword }}"
      password: "{{ bigIqCMPassword }}"
      password2: "{{ bigIqCMPassword }}"
      encryptedPassword: null
    body_format: json

#- name: Set Root Credentials {{bigIqCM}}
#  uri:
#    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/shared/authn/root"
#    method: POST
#    validate_certs: no
#    user: root
#    password: "{{ bigIqCMPassword }}"
#    body:
#      oldPassword:
#      password: "{{ bigIqCMPassword }}"
#      password2: "{{ bigIqCMPassword }}"
#    body_format: json

- name: Exit Wizard {{bigIqCM}}
  uri:
    url: "https://{{bigIqCM_mgmt_pip}}/mgmt/shared/system/setup"
    method: PATCH
    validate_certs: no
    user: "{{ bigIqCMAdmin }}"
    password: "{{ bigIqCMPassword }}"
    body:
      isSystemSetup: true
    body_format: json
